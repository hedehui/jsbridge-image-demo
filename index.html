<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ç‰‡è·å–å¯¹æ¯” Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 10px 5px; padding: 10px 20px; font-size: 16px; }
    img { max-width: 100%; margin-top: 20px; border: 1px solid #ddd; }
    .section { margin-top: 30px; }
    pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>

  <h2>ğŸ“¸ å›¾ç‰‡è·å–æ€§èƒ½å¯¹æ¯”ï¼ˆBase64 vs è·¯å¾„ï¼‰</h2>

  <div class="section">
    <button onclick="getImage('path')">é€šè¿‡è·¯å¾„è·å–å›¾ç‰‡</button>
    <button onclick="getImage('base64')">é€šè¿‡ Base64 è·å–å›¾ç‰‡</button>
  </div>

  <div class="section">
    <h3>ğŸ–¼ é¢„è§ˆ</h3>
    <img id="preview" alt="å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨æ­¤" />
  </div>

  <div class="section">
    <h3>ğŸ“Š æ€§èƒ½æ—¥å¿—</h3>
    <pre id="log">ç­‰å¾…æ“ä½œä¸­...</pre>
  </div>

  <script>
    window.JSBridge = {
      _callbacks: {},
      callHandler(method, params = {}, callback) {
        const callbackId = method + '_' + Date.now();
        this._callbacks[callbackId] = callback;
        const message = { method, params, callbackId };

        if (window.webkit?.messageHandlers?.JSBridge) {
          window.webkit.messageHandlers.JSBridge.postMessage(message);
        } else if (window.JSBridgeAndroid) {
          window.JSBridgeAndroid.callHandler(method, JSON.stringify({ ...params, callbackId }));
        } else if (window.harmonyPostMessage) {
          window.harmonyPostMessage(JSON.stringify(message));
        } else {
          alert("å½“å‰å¹³å°ä¸æ”¯æŒ JSBridge");
        }
      },
      _nativeCallback(callbackId, data) {
        if (this._callbacks[callbackId]) {
          this._callbacks[callbackId](data);
          delete this._callbacks[callbackId];
        }
      }
    };

    function getImage(mode) {
      const log = document.getElementById('log');
      const img = document.getElementById('preview');
      img.src = '';
      log.innerText = `ğŸ”„ æ­£åœ¨è·å–å›¾ç‰‡ï¼ˆ${mode === 'base64' ? 'Base64' : 'è·¯å¾„'}æ¨¡å¼ï¼‰...`;

      const start = performance.now();

      JSBridge.callHandler('getImage', { mode: mode }, function (res) {
        const receiveTime = performance.now();
        if (res.code === 0 && res.data) {
          if (mode === 'base64') {
            img.src = 'data:image/jpeg;base64,' + res.data.base64;
          } else {
            img.src = res.data.path;
          }

          img.onload = () => {
            const end = performance.now();
            log.innerText =
              `âœ… å›¾ç‰‡åŠ è½½å®Œæˆ\n` +
              `JSBridge å“åº”è€—æ—¶: ${(receiveTime - start).toFixed(2)}ms\n` +
              `å›¾ç‰‡æ¸²æŸ“è€—æ—¶: ${(end - receiveTime).toFixed(2)}ms\n` +
              `æ€»è€—æ—¶: ${(end - start).toFixed(2)}ms`;
          };
        } else {
          log.innerText = 'âŒ è·å–å¤±è´¥ï¼š' + res.msg;
        }
      });
    }
  </script>
</body>
</html>